# BMM150 磁気センサー マイクロコントローラ向け実装ガイド

## 導入

本ガイドは、Bosch Sensortec社製 高性能3軸磁気センサー BMM150をマイクロコントローラ（マイコン）と連携させるための実装手順を解説する技術ドキュメントです。BMM150は、電子コンパスやナビゲーション、拡張現実（AR）など、多岐にわたるアプリケーションの実現を可能にします。このガイドでは、センサーの初期化からデータ取得、さらにはシステムリソースを効率的に活用するための運用方法までをステップバイステップで解説し、開発者が直面するであろう技術的な課題を解決することを目的としています。

本ガイドで解説する主要なトピックは以下の通りです。

- **基本仕様の理解**: センサーの性能、通信インターフェース、座標系の定義
- **初期化シーケンス**: 電源投入後の正しい起動手順とモード遷移
- **データ読み取り**: 測定データの構造と一貫性を保証する読み取り方法
- **効率的なデータ取得手法**: ポーリングに代わる割り込みやオンデマンド測定の活用

それでは、実装を始める前に不可欠なBMM150の基本機能と仕様について、次のセクションで詳しく見ていきましょう。

---

## 1. BMM150の基本機能と仕様の理解

センサーを効果的に使用するためには、その基本的な能力と仕様を理解することが最初の重要なステップです。このセクションでは、センサーの性能限界、マイコンとの通信方法、そして測定データがどの物理的な向きに対応するかを定義する座標系といった、後のプログラミングで前提となる知識を提供します。これらの基本事項を正しく把握することで、実装時の手戻りを防ぎ、センサーの性能を最大限に引き出すことが可能になります。

### BMM150の主要な特徴

データシートに記載されているBMM150の主な特徴は以下の通りです。

- **3軸磁気センサー**: 互いに直交する3つの軸（X, Y, Z）の磁場を測定します。
- **超小型パッケージ**: わずか 1.56 x 1.56 mm² のWafer Level Chip Scale Package (WLCSP) を採用しており、基板上の配置自由度が高いです。
- **デジタルインターフェース**: SPI（3線式/4線式）および I²C の両方の通信プロトコルをサポートします。
- **低電圧動作**: 幅広い電圧範囲（VDD: 1.62V to 3.6V, VDDIO: 1.2V to 3.6V）で動作し、低消費電力システムに適しています。
- **磁場検出範囲**: x, y軸で±1300µT、z軸で±2500µTという広範な磁場を検出できます。
- **割り込みコントローラ搭載**: データ準備完了（Data Ready）や閾値検出などのイベントをマイコンに通知する割り込み機能を内蔵しています。

### デジタルインターフェースの選択

BMM150は、PS（Protocol Select）ピンの状態によって使用するデジタルインターフェースが決定されます。マイコンとの接続に合わせて、ピンの状態を正しく設定する必要があります。

- **I²Cモード**: PSピンを "1"（VDDIOレベル）に設定します。
- **SPIモード**: PSピンを "0"（GNDレベル）に設定します。

### センサーの座標系

センサーから得られるデータを正しく解釈するためには、センサーの物理的な向きとX, Y, Zの各軸がどのように対応しているかを理解することが極めて重要です。下図は、センサーパッケージに対する各軸の方向を示しています。例えば、基板に実装されたセンサーの上面からZ軸が正の方向に出ており、X軸とY軸はパッケージの側面に沿って定義されています。

> **図21: Orientation of sensing axes を基にした説明**
> (注: 上図はデータシートの図21を模式的に表現したものです)

X軸が地磁気の北を向いたとき、X軸の出力は正の値を示します。この座標系の定義は、電子コンパスなどを実装する際の計算の基礎となります。

これでセンサーの基本的な特性が明確になりました。次に、マイコンでセンサーを起動するための具体的な初期化シーケンスについて解説します。

---

## 2. 初期化シーケンス：サスペンドからアクティブモードへ

BMM150の電源投入後の状態遷移（パワーモード）を正しく管理することは、センサーの安定した動作を保証する鍵となります。電源を投入した直後、BMM150は全ての機能が停止した「サスペンドモード」で起動します。このセクションでは、このサスペンドモードから、レジスタ設定が可能になる「スリープモード」を経由し、最終的に磁場の測定を行う「アクティブモード」へと移行するまでの具体的な手順を詳述します。

BMM150の初期化は、以下のステップに従って行います。

### 1. 電源投入とサスペンドモード

VDDとVDDIOに電源が供給されると、パワーオンリセット（POR）が実行され、デバイスは自動的にサスペンドモードで起動します。このモードでは消費電力が極限まで抑えられていますが、ほとんどの機能が停止しています。

- **重要な注意点**: サスペンドモードでは、パワー制御レジスタ（アドレス `0x4B`）のみがアクセス可能です。この状態で他のレジスタ、例えばチップIDレジスタ（`0x40`）を読み出そうとしても、正しい値は返されず `0x00` が読み出されます。

### 2. スリープモードへの移行

センサーの内部レジスタにアクセスして設定を行うためには、まずスリープモードへ移行する必要があります。

- **操作**: パワー制御レジスタ（`0x4B`）のビット0にある「Power Control bit」に `1` を書き込みます。
- **結果**: この操作により、BMM150はスリープモードに移行し、チップIDを含む全てのレジスタへの読み書きが可能になります。

### 3. チップIDの確認（通信確認）

スリープモードに移行したら、センサーとの通信が正しく確立されているかを確認します。これは、一般的に「生存確認（Health Check）」と呼ばれるプロセスです。

- **操作**: チップIDレジスタ（`0x40`）を読み出します。
- **確認**: 読み出した値が `0x32` であれば、センサーは正常に起動しており、マイコンとの通信も正しく行われていることを示します。

### 4. アクティブモードへの移行

通信確認が完了したら、実際に磁場測定を開始するためにアクティブモードへ移行します。

- **操作**: オペレーションモード制御レジスタ（`0x4C`）のビット2とビット1で構成される「Opmode <1:0>」に `00b` を書き込みます。
- **結果**: これにより、センサーは「ノーマルモード」に移行し、設定されたデータレートで周期的な測定を開始します。

### 推奨プリセットの活用

BMM150は、測定の繰り返し回数などを細かく設定できますが、アプリケーションの要求に応じて最適な設定を見つけるのは複雑な場合があります。そこで、データシートでは一般的なユースケースに対応した4つの推奨プリセットが提供されています。これらのプリセットは、レジスタ `0x51`（REPXY）と `0x52`（REPZ）の値を適切に設定することで、消費電力と測定精度のバランスを容易に取ることができます。以下の表は、各プリセットの性能と消費電力のトレードオフを示しており、設計上の意思決定に役立ちます。

#### 表3: Recommended presets

| プリセット名 | Rep. X/Y (nXY) | Rep. Z (nZ) | RMS Noise x/y/z (µT) | 平均消費電流 (mA @ ODR) |
|---|---|---|---|---|
| Low power | 3 | 3 | 1.0/1.0/1.4 | 0.17 @ 10Hz |
| Regular | 9 | 15 | 0.6/0.6/0.6 | 0.5 @ 10Hz |
| Enhanced regular | 15 | 27 | 0.5/0.5/0.5 | 0.8 @ 10Hz |
| High accuracy | 47 | 83 | 0.3/0.3/0.3 | 4.9 @ 20Hz |

センサーの初期化と測定開始の準備が整いました。次のセクションでは、測定された磁気データをマイコンでどのように読み取り、解釈するかについて詳しく見ていきましょう。

---

## 3. 磁気データの読み取りと解釈

センサーがアクティブモードで測定を開始すると、データレジスタに測定結果が格納されます。マイコンがそのデータを正確に取得し、意味のある物理量に変換するプロセスは、アプリケーションの信頼性を左右する重要な工程です。このセクションでは、データレジスタの構造、データの一貫性を保つための安全な読み取り方法、そして生データから実際の磁場データ（µT）への変換の概要について解説します。

### 3.1. データレディステータスの確認

新しい測定データが利用可能になったことを知るには、データレディステータスを確認します。RHALLレジスタ（`0x48`）のビット0にある「Data Ready Status」フラグがこの役割を担います。

- **ポーリング**: マイコンがこのビットを周期的に読み出し、`1` になるのを待ちます。`1` になったら、新しいデータが準備完了したことを意味します。
- **割り込み**: より効率的な方法として、後述するDRDY割り込みを利用することもできます。

このフラグは、いずれかのデータレジスタの読み出しが完了し、通信が終了（I²CではSTOPコンディション発行、SPIではCSBがHighに遷移）した直後に自動的に `0` にクリアされます。

### 3.2. データレジスタの構造

X, Y, Z軸の磁気データと、温度補償に使用されるRHALL（ホール素子の抵抗値）データは、レジスタ `0x42` から `0x49` にかけて格納されています。各データのビット幅と形式は異なり、正しく結合して解釈する必要があります。

| データ | レジスタ (LSB, MSB) | ビット幅 | データ形式 |
|---|---|---|---|
| X軸 | 0x42 (LSB[4:0]), 0x43 (MSB[12:5]) | 13ビット | 2の補数 |
| Y軸 | 0x44 (LSB[4:0]), 0x45 (MSB[12:5]) | 13ビット | 2の補数 |
| Z軸 | 0x46 (LSB[6:0]), 0x47 (MSB[14:7]) | 15ビット | 2の補数 |
| RHALL | 0x48 (LSB[5:0]), 0x49 (MSB[13:6]) | 14ビット | 符号なし |

### 3.3. 安全なデータ読み取り（バーストリード）

データの読み出し中にセンサー内部で値が更新されると、例えばX軸の古いデータとY軸の新しいデータが混在してしまう「軸の混合（axis mix-up）」という問題が発生する可能性があります。これを防ぐため、BMM150にはシャドウレジスタ機能が搭載されています。

データの一貫性を保証するため、データシートではレジスタ `0x42` から `0x49` までを一度の通信シーケンスでまとめて読み出す**「バーストリード」**を強く推奨しています。バーストリード中はデータレジスタの更新がブロックされ、新しいデータは一時的にシャドウレジスタに格納されます。通信が完了すると、シャドウレジスタの内容がデータレジスタに反映されます。これにより、常に3軸＋RHALLの同期が取れた一貫性のあるデータセットを取得できます。

### 3.4. 生データの解釈

レジスタから読み出した値は、センサーの個体差や温度特性を含む**「生データ」**です。これをそのまま物理的な磁場単位であるµT（マイクロテスラ）として使用することはできません。

> **図3: Calculation flow of magnetic field data**
> (注: 上図はデータシートの図3を模式的に表現したものです)

最終的な磁場データを得るには、RHALLレジスタの値を用いた温度補償計算が必要です。この複雑な補償計算は、Bosch Sensortecが提供する公式のAPI/ドライバに実装されています。開発者はこのAPIを利用することで、自身で補償アルゴリズムを実装することなく、生データから正確なµT単位の磁場データを容易に得ることができます。

これで基本的なデータ読み取り方法を習得しましたが、より高度なアプリケーションでは、CPUリソースを節約するため、ポーリングよりも効率的なデータ取得方法が求められます。次のセクションでは、そのためのテクニックを紹介します。

---

## 4. 効率的なデータ取得手法

多くの組み込みシステムにおいて、CPUリソースの節約とリアルタイム性の確保は極めて重要です。単純なポーリング方式は実装が容易ですが、CPUが常にセンサーの状態を監視し続けるため、非効率的です。このセクションでは、ポーリングに代わる、より高度で効率的なデータ取得方法として、割り込みを利用したイベント駆動型のアプローチと、特定のタイミングで能動的に測定をトリガーする方法を紹介します。

### 4.1. DRDY割り込みの活用によるイベント駆動型データ取得

DRDY（Data Ready）割り込みは、センサーが新しいデータの測定と格納を完了したタイミングで、マイコンに通知を送る機能です。

- **利点**: この機能を利用することで、マイコンはデータレディフラグを常時監視（ポーリング）する必要がなくなります。データが準備できるまでCPUはスリープ状態に入ったり、他のタスクを実行したりできるため、システム全体の処理効率が向上し、消費電力を大幅に削減できます。
- **有効化手順**: DRDY割り込みを使用するには、レジスタ `0x4E` のビット7にある「Data Ready Pin En」を `1` に設定します。これにより、DRDYピンが有効になります。

> **図5: Data acquisition and DRDY operation を基にしたシーケンス**

1. センサーが測定を開始します。
2. 測定とデータレジスタへの書き込みが完了すると、DRDYピンがアサートされます（デフォルトではHighアクティブ）。
3. マイコンは割り込みを検知し、データ読み出し処理を開始します。
4. データ読み出しが完了すると、DRDYピンは自動的にクリア（デアサート）され、次の測定完了を待つ状態になります。

### 4.2. フォーストモードによる同期的データ取得

フォーストモードは、ノーマルモードのような周期的な自動測定ではなく、ホスト（マイコン）からの命令によって一度だけ測定を実行するオンデマンドの動作モードです。

- **利点**: このモードは、加速度センサーなど他のセンサーと測定タイミングを厳密に同期させたい場合や、ノーマルモードで設定可能なデータレート以外の任意の周期でデータを取得したい場合に非常に有効です。
- **使用手順**:
  1. オペレーションモード制御レジスタ（`0x4C`）の「Opmode <1:0>」に `01b` を書き込み、フォーストモードをトリガーします。
  2. センサーは一度の測定シーケンス（X, Y, Z, RHALL）を実行します。
  3. 測定データがデータレジスタに書き込まれると、センサーは自動的にスリープモードに戻ります（Opmodeが `11b` に戻る）。マイコンは次の測定が必要になるまで、再度フォーストモードをトリガーします。

フォーストモードで実現可能な最大データレートは、測定の繰り返し回数（nXY, nZ）に依存し、以下の式で概算できます。これにより、設定した精度（繰り返し回数）でどれくらいの速さで測定できるかを見積もることが可能です。

```
f_max,ODR ≈ 1 / (145µs * nXY + 500µs * nZ + 980µs)
```

ここで nXY と nZ は、レジスタ `0x51`, `0x52` の生の値ではなく、そこから算出される実際の測定繰り返し回数である点に注意が必要です。

これら二つの手法（DRDY割り込みとフォーストモード）をアプリケーションの要求に応じて使い分けることで、柔軟かつ効率的なデータ取得アーキテクチャを構築できます。

---

## 5. まとめ

本ガイドでは、BMM150磁気センサーをマイクロコントローラと連携させて使用するための重要なステップを解説しました。実装における主要なポイントを以下に要約します。

- **初期化**: センサーの安定動作には、電源投入後のサスペンド → スリープ → アクティブという正確なパワーモード遷移が不可欠です。特にスリープモードへ移行しないとレジスタ設定ができない点に注意が必要です。
- **データ読み取り**: X, Y, Z軸のデータが同期ズレを起こす「軸の混合」を防ぐため、データレジスタ（`0x42`～`0x49`）は必ずバーストリードで一括して読み取ることが強く推奨されます。
- **効率的な取得**: CPUリソースを効率的に使用するため、ポーリングの代わりにDRDY割り込みを活用したイベント駆動型アーキテクチャの導入を検討してください。また、他のセンサーとの同期や任意のデータレートが必要な場合は、フォーストモードが有効な選択肢となります。

これらの手順とテクニックを適切に実装することで、BMM150の持つポテンシャルを最大限に引き出し、高精度で信頼性の高いアプリケーションを構築できるでしょう。
